<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  - Supabaseç‰ˆ</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="shortcut icon" type="image/png" href="favicon.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            color: #000000;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #000000;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1rem;
            color: #666666;
            font-weight: 300;
        }

        /* çµ±è¨ˆã‚«ãƒ¼ãƒ‰ */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: #ffffff;
            border: 1px solid #000000;
            padding: 30px 20px;
            text-align: center;
            transition: all 0.2s ease;
        }

        .stat-card:hover {
            box-shadow: 0 0 0 2px #000000;
        }

        .stat-number {
            font-size: 3rem;
            font-weight: 100;
            color: #000000;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: #666666;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒ‘ãƒãƒ« */
        .controls {
            background: #ffffff;
            border: 1px solid #000000;
            padding: 30px;
            margin-bottom: 40px;
        }

        .control-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .btn {
            background: #ffffff;
            border: 1px solid #000000;
            color: #000000;
            padding: 12px 24px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-block;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            background: #000000;
            color: #ffffff;
        }

        .btn-primary {
            background: #000000;
            color: #ffffff;
        }

        .btn-primary:hover {
            background: #333333;
        }

        .filter-group {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-select {
            background: #ffffff;
            border: 1px solid #000000;
            color: #000000;
            padding: 12px 16px;
            font-size: 0.9rem;
            min-width: 150px;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            box-shadow: 0 0 0 2px #000000;
        }

        /* åœ¨åº«ã‚°ãƒªãƒƒãƒ‰ */
        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .inventory-item {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            padding: 25px;
            transition: all 0.2s ease;
        }

        .inventory-item:hover {
            border-color: #000000;
        }

        .inventory-item.low-stock {
            border-color: #ff6b35;
            border-width: 2px;
        }

        .inventory-item.out-of-stock {
            border-color: #ff0000;
            border-width: 2px;
        }

        /* ã‚¢ã‚¤ãƒ†ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ */
        .item-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .item-name {
            font-size: 1.3rem;
            font-weight: 400;
            margin-bottom: 8px;
            color: #000000;
        }

        .item-meta {
            font-size: 0.85rem;
            color: #666666;
            line-height: 1.4;
        }

        /* åœ¨åº«æƒ…å ± */
        .stock-info {
            margin-bottom: 20px;
        }

        .stock-display {
            font-size: 1.1rem;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8f8f8;
            border: 1px solid #e0e0e0;
            text-align: center;
        }

        .stock-display.out {
            background: #ffe6e6;
            border-color: #ff0000;
            color: #cc0000;
        }

        .stock-display.low {
            background: #fff3e6;
            border-color: #ff6b35;
            color: #cc4400;
        }

        /* ãƒœã‚¿ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
        .stock-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .stock-btn {
            background: #ffffff;
            border: 1px solid #000000;
            color: #000000;
            padding: 8px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 60px;
            text-align: center;
            font-weight: 400;
        }

        .stock-btn:hover {
            background: #000000;
            color: #ffffff;
        }

        .stock-btn.decrease {
            border-color: #ff6b35;
            color: #ff6b35;
        }

        .stock-btn.decrease:hover {
            background: #ff6b35;
            color: #ffffff;
        }

        .stock-btn.increase {
            border-color: #28a745;
            color: #28a745;
        }

        .stock-btn.increase:hover {
            background: #28a745;
            color: #ffffff;
        }

        /* ç™ºæ³¨é€šçŸ¥ */
        .order-notification {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }

        .notification-btn {
            background: #ff6b35;
            border: 1px solid #ff6b35;
            color: #ffffff;
            padding: 12px 20px;
            font-size: 0.9rem;
            cursor: pointer;
            width: 100%;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .notification-btn:hover {
            background: #e55a2b;
            border-color: #e55a2b;
        }

        /* é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffffff;
            border: 2px solid #000000;
            color: #000000;
            padding: 15px 20px;
            z-index: 1000;
            max-width: 400px;
            font-weight: 500;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-color: #28a745;
            color: #28a745;
        }

        .notification.error {
            border-color: #ff0000;
            color: #ff0000;
        }

        /* ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚° */
        .loading {
            text-align: center;
            padding: 60px 20px;
            font-size: 1.1rem;
            color: #666666;
            grid-column: 1 / -1;
        }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ– */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .stats {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                gap: 15px;
            }

            .controls {
                padding: 20px;
            }

            .control-group {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }

            .btn, .filter-select {
                width: 100%;
                text-align: center;
            }

            .inventory-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .stock-controls {
                gap: 5px;
            }

            .stock-btn {
                font-size: 0.75rem;
                padding: 6px 8px;
                min-width: 50px;
            }
        }

        @media (max-width: 480px) {
            .stock-controls {
                flex-direction: column;
            }

            .stock-btn {
                flex: none;
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸª åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </h1>
            <p>Supabaseç‰ˆãƒ»ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åœ¨åº«ç®¡ç†ï¼ˆã‚«ãƒƒãƒˆæ•°å¯¾å¿œï¼‰</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalItems">-</div>
                <div class="stat-label">ç·ã‚¢ã‚¤ãƒ†ãƒ æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lowStockItems">-</div>
                <div class="stat-label">åœ¨åº«ä¸è¶³</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalStores">-</div>
                <div class="stat-label">åº—èˆ—æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalSuppliers">-</div>
                <div class="stat-label">ä»•å…¥å…ˆæ•°</div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <button class="btn btn-primary" onclick="loadInventory()">
                    ğŸ”„ ãƒ‡ãƒ¼ã‚¿æ›´æ–°
                </button>
                <button class="btn btn-secondary" onclick="testChatWorkNotification()">
                    ğŸ§ª ChatWorkãƒ†ã‚¹ãƒˆ
                </button>
                <a href="#" target="_blank" class="btn btn-warning" id="supabaseLink">
                    âš™ï¸ Supabaseç®¡ç†ç”»é¢
                </a>
            </div>
            
            <div class="control-group">
                <div class="filter-group">
                    <select class="filter-select" id="storeFilter" onchange="filterInventory()">
                        <option value="">å…¨åº—èˆ—</option>
                    </select>
                    <select class="filter-select" id="supplierFilter" onchange="filterInventory()">
                        <option value="">å…¨ä»•å…¥å…ˆ</option>
                    </select>
                    <select class="filter-select" id="categoryFilter" onchange="filterInventory()">
                        <option value="">å…¨ã‚«ãƒ†ã‚´ãƒª</option>
                    </select>
                    <select class="filter-select" id="statusFilter" onchange="filterInventory()">
                        <option value="">å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</option>
                        <option value="low">åœ¨åº«ä¸è¶³</option>
                        <option value="out">åœ¨åº«åˆ‡ã‚Œ</option>
                        <option value="normal">æ­£å¸¸</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="inventory-grid" id="inventoryGrid">
            <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
    </div>

    <script>
        // ç’°å¢ƒå¤‰æ•°ã‹ã‚‰è¨­å®šã‚’å–å¾—ï¼ˆVercelç’°å¢ƒå¤‰æ•°å¯¾å¿œï¼‰
        const SUPABASE_URL = 'https://yyoixwdljeoxtieeazfo.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5b2l4d2RsamVveHRpZWVhemZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjY3NTQsImV4cCI6MjA2OTUwMjc1NH0.Lp1GLRlXI57odcpNhSl5TB2bOKSS        // ChatWorkè¨­å®šï¼ˆç’°å¢ƒå¤‰æ•°ã§ç®¡ç†ã•ã‚Œã‚‹ãŸã‚ã€ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ã¯ä¸è¦ï¼‰
        // const CHATWORK_API_TOKEN = 'ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç†'
        // const CHATWORK_ROOM_ID = 'ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã§ç®¡ç†'     let inventoryData = []
        let filteredData = []

        // åˆæœŸåŒ–æ™‚ã«Supabaseãƒªãƒ³ã‚¯ã‚’è¨­å®š
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('supabaseLink').href = SUPABASE_URL
            console.log('Page loaded, initializing...')
            setTimeout(() => {
                loadInventory()
            }, 1000)
        })

        // Supabase REST APIå‘¼ã³å‡ºã—é–¢æ•°ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
        async function supabaseRequest(endpoint, options = {}) {
            const url = `${SUPABASE_URL}/rest/v1${endpoint}`
            
            const defaultOptions = {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                }
            }

            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            }

            console.log('Supabase Request:', url, finalOptions)

            try {
                const response = await fetch(url, finalOptions)
                console.log('Supabase Response Status:', response.status)
                
                if (!response.ok) {
                    const errorText = await response.text()
                    console.error('Supabase Error Response:', errorText)
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`)
                }
                
                // PATCHãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å ´åˆã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒœãƒ‡ã‚£ãŒç©ºã®å ´åˆãŒã‚ã‚‹
                if (options.method === 'PATCH' && response.status === 204) {
                    return { success: true }
                }
                
                const data = await response.json()
                console.log('Supabase Response Data:', data)
                return data
            } catch (error) {
                console.error('Supabase Request Error:', error)
                throw error
            }
        }

        // åœ¨åº«ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–ï¼‰
        async function loadInventory() {
            console.log('Loading inventory data...')
            
            try {
                document.getElementById('inventoryGrid').innerHTML = '<div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ä¸­...</div>'
                
                const data = await supabaseRequest('/inventory_items?select=*&order=name')
                console.log('Loaded inventory data:', data)
                
                if (Array.isArray(data)) {
                    inventoryData = data
                    filteredData = [...inventoryData]
                    
                    updateStats()
                    updateFilters()
                    renderInventory()
                    
                    showNotification(`${inventoryData.length}ä»¶ã®ã‚¢ã‚¤ãƒ†ãƒ ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`, 'success')
                } else {
                    throw new Error('Invalid data format received')
                }
            } catch (error) {
                console.error('Error loading inventory:', error)
                document.getElementById('inventoryGrid').innerHTML = `
                    <div class="loading">
                        ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ<br>
                        ã‚¨ãƒ©ãƒ¼: ${error.message}<br>
                        <button class="btn btn-primary" onclick="loadInventory()" style="margin-top: 10px;">å†è©¦è¡Œ</button>
                    </div>
                `
                showNotification('ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'error')
            }
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats() {
            const totalItems = inventoryData.length
            const lowStockItems = inventoryData.filter(item => item.current_stock <= item.min_stock).length
            const stores = [...new Set(inventoryData.map(item => item.store))]
            const suppliers = [...new Set(inventoryData.map(item => item.supplier))]

            document.getElementById('totalItems').textContent = totalItems
            document.getElementById('lowStockItems').textContent = lowStockItems
            document.getElementById('totalStores').textContent = stores.length
            document.getElementById('totalSuppliers').textContent = suppliers.length
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ›´æ–°
        function updateFilters() {
            const stores = [...new Set(inventoryData.map(item => item.store))].sort()
            const suppliers = [...new Set(inventoryData.map(item => item.supplier))].sort()
            const categories = [...new Set(inventoryData.map(item => item.category))].filter(cat => cat).sort()

            updateSelectOptions('storeFilter', stores)
            updateSelectOptions('supplierFilter', suppliers)
            updateSelectOptions('categoryFilter', categories)
        }

        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId)
            const currentValue = select.value
            
            while (select.children.length > 1) {
                select.removeChild(select.lastChild)
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option')
                optionElement.value = option
                optionElement.textContent = option
                select.appendChild(optionElement)
            })
            
            select.value = currentValue
        }

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        function filterInventory() {
            const storeFilter = document.getElementById('storeFilter').value
            const supplierFilter = document.getElementById('supplierFilter').value
            const categoryFilter = document.getElementById('categoryFilter').value
            const statusFilter = document.getElementById('statusFilter').value

            filteredData = inventoryData.filter(item => {
                const storeMatch = !storeFilter || item.store === storeFilter
                const supplierMatch = !supplierFilter || item.supplier === supplierFilter
                const categoryMatch = !categoryFilter || item.category === categoryFilter
                
                let statusMatch = true
                if (statusFilter === 'low') {
                    statusMatch = item.current_stock <= item.min_stock && item.current_stock > 0
                } else if (statusFilter === 'out') {
                    statusMatch = item.current_stock <= 0
                } else if (statusFilter === 'normal') {
                    statusMatch = item.current_stock > item.min_stock
                }

                return storeMatch && supplierMatch && categoryMatch && statusMatch
            })

            renderInventory()
        }

        // å˜ä½ã«å¿œã˜ãŸåœ¨åº«è¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatStock(stock, unit) {
            // å€‹æ•°ç³»ã®å˜ä½ã¯æ•´æ•°è¡¨ç¤º
            if (unit === 'å€‹' || unit === 'ç®±' || unit === 'è¢‹' || unit === 'æš') {
                return Math.floor(stock);
            }
            // æ¶²ä½“ãƒ»é‡é‡ç³»ã¯å°æ•°ç‚¹è¡¨ç¤º
            return parseFloat(stock).toString();
        }

        // ã‚«ãƒƒãƒˆæ•°æƒ…å ±ã®è§£æ
        function parseCutInfo(notes) {
            if (!notes) return null
            
            const cutMatch = notes.match(/(\d+(?:\.\d+)?)æœ¬\+ã‚«ãƒƒãƒˆ(\d+(?:\.\d+)?)/)
            if (cutMatch) {
                return {
                    bottles: parseFloat(cutMatch[1]),
                    cuts: parseFloat(cutMatch[2])
                }
            }
            return null
        }

        // åœ¨åº«è¡¨ç¤º
        function renderInventory() {
            const grid = document.getElementById('inventoryGrid')
            
            if (filteredData.length === 0) {
                grid.innerHTML = '<div class="loading">è©²å½“ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ ãŒã‚ã‚Šã¾ã›ã‚“</div>'
                return
            }

            grid.innerHTML = filteredData.map(item => {
                const isLowStock = item.current_stock <= item.min_stock && item.current_stock > 0
                const isOutOfStock = item.current_stock <= 0
                const cutInfo = parseCutInfo(item.notes)
                
                let statusClass = ''
                if (isOutOfStock) {
                    statusClass = 'out-of-stock'
                } else if (isLowStock) {
                    statusClass = 'low-stock'
                }

                let stockDisplay = ''
                if (cutInfo) {
                    // ã‚«ãƒƒãƒˆæ•°å¯¾å¿œã‚¢ã‚¤ãƒ†ãƒ ã‚‚é€šå¸¸ã®åœ¨åº«ç®¡ç†ã«çµ±ä¸€
                    const totalStock = cutInfo.bottles + (cutInfo.cuts * 0.1) // ã‚«ãƒƒãƒˆæ•°ã‚’0.1æœ¬ã¨ã—ã¦è¨ˆç®—
                    stockDisplay = `
                        <div class="stock-info">
                            <div class="stock-display">
                                ç¾åœ¨: ${formatStock(totalStock, item.unit)}${item.unit}
                            </div>
                            <div class="stock-controls">
                                <button class="stock-btn decrease" onclick="updateStock(${item.id}, ${totalStock - 1})">-1</button>
                                <button class="stock-btn increase" onclick="updateStock(${item.id}, ${totalStock + 1})">+1</button>
                            </div>
                        </div>
                    `
                } else {
                    const stockClass = isOutOfStock ? 'out' : (isLowStock ? 'low' : '')
                    stockDisplay = `
                        <div class="stock-info">
                            <div class="stock-display ${stockClass}">
                                ç¾åœ¨: ${formatStock(item.current_stock, item.unit)}${item.unit}
                            </div>
                            <div class="stock-controls">
                                <button class="stock-btn decrease" onclick="updateStock(${item.id}, ${item.current_stock - 1})">-1</button>
                                <button class="stock-btn increase" onclick="updateStock(${item.id}, ${item.current_stock + 1})">+1</button>
                            </div>
                        </div>
                    `
                }

                const needsOrder = item.current_stock <= item.min_stock
                const orderButton = needsOrder ? `
                    <div class="order-notification">
                        <button class="notification-btn" onclick="sendOrderNotification(${item.id})">
                            ğŸ“± ç™ºæ³¨é€šçŸ¥
                        </button>
                    </div>
                ` : ''

                return `
                    <div class="inventory-item ${statusClass}">
                        <div class="item-header">
                            <div>
                                <div class="item-name">${item.name}</div>
                                <div class="item-meta">
                                    ğŸª ${item.store} | ğŸ“¦ ${item.supplier} | ğŸ“‚ ${item.category || 'æœªåˆ†é¡'}
                                </div>
                            </div>
                        </div>
                        ${stockDisplay}
                        ${orderButton}
                    </div>
                `
            }).join('')
        }

        // ã‚«ãƒƒãƒˆæ•°èª¿æ•´
        function adjustCutStock(itemId, type, amount) {
            const input = document.getElementById(`${type}-${itemId}`)
            const currentValue = parseFloat(input.value) || 0
            const newValue = Math.max(0, currentValue + amount)
            input.value = newValue
        }

        // ã‚«ãƒƒãƒˆæ•°æ›´æ–°
        async function updateCutStock(itemId) {
            const bottlesInput = document.getElementById(`bottles-${itemId}`)
            const cutsInput = document.getElementById(`cuts-${itemId}`)
            
            const bottles = parseFloat(bottlesInput.value) || 0
            const cuts = parseFloat(cutsInput.value) || 0
            
            if (bottles < 0 || cuts < 0) {
                showNotification('æœ¬æ•°ãƒ»ã‚«ãƒƒãƒˆæ•°ã¯0ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', 'error')
                return
            }

            try {
                const notes = generateCutNotes(bottles, cuts)
                
                await supabaseRequest(`/inventory_items?id=eq.${itemId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ 
                        current_stock: bottles,
                        notes: notes
                    })
                })

                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                const itemIndex = inventoryData.findIndex(item => item.id === itemId)
                if (itemIndex !== -1) {
                    inventoryData[itemIndex].current_stock = bottles
                    inventoryData[itemIndex].notes = notes
                }
                
                filterInventory()
                updateStats()
                showNotification('ã‚«ãƒƒãƒˆæ•°ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success')
            } catch (error) {
                console.error('Error updating cut stock:', error)
                showNotification(`ã‚«ãƒƒãƒˆæ•°æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error')
            }
        }

        // åœ¨åº«æ›´æ–°
        async function updateStock(itemId, newStock) {
            if (newStock < 0) {
                showNotification('åœ¨åº«æ•°ã¯0ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™', 'error')
                return
            }

            try {
                await supabaseRequest(`/inventory_items?id=eq.${itemId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ current_stock: newStock })
                })

                // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚‚æ›´æ–°
                const itemIndex = inventoryData.findIndex(item => item.id === itemId)
                if (itemIndex !== -1) {
                    inventoryData[itemIndex].current_stock = newStock
                }
                
                filterInventory()
                updateStats()
                showNotification('åœ¨åº«ã‚’æ›´æ–°ã—ã¾ã—ãŸ', 'success')
            } catch (error) {
                console.error('Error updating stock:', error)
                showNotification(`åœ¨åº«æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error')
            }
        }

        // ç™ºæ³¨é€šçŸ¥é€ä¿¡
        async function sendOrderNotification(itemId) {
            try {
                const item = inventoryData.find(item => item.id === itemId)
                if (item) {
                    await sendChatWorkNotification(item)
                }
            } catch (error) {
                console.error('Error sending order notification:', error)
                showNotification(`ç™ºæ³¨é€šçŸ¥ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error')
            }
        }

        // ChatWorké€šçŸ¥é€ä¿¡ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å‡¦ç†ï¼‰
        async function sendChatWorkNotification(item) {
            try {
                const cutInfo = parseCutInfo(item.notes)
                let stockInfo = ''
                
                if (cutInfo) {
                    stockInfo = `${cutInfo.bottles}æœ¬+ã‚«ãƒƒãƒˆ${cutInfo.cuts}`
                } else {
                    stockInfo = `${item.current_stock}${item.unit}`
                }

                const message = `ğŸš¨ åœ¨åº«ä¸è¶³é€šçŸ¥

ğŸ“¦ å•†å“å: ${item.name}
ğŸª åº—èˆ—: ${item.store}
ğŸ“‹ ä»•å…¥å…ˆ: ${item.supplier}
ğŸ“Š ç¾åœ¨åœ¨åº«: ${stockInfo}
ğŸ“ ç™ºæ³¨æ•°: ${item.order_qty}${item.unit}

ç™ºæ³¨ãŒå¿…è¦ã§ã™ã€‚

é€ä¿¡æ™‚åˆ»: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}`

                console.log('Sending ChatWork message:', message)

                // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰APIçµŒç”±ã§ChatWorké€šçŸ¥ã‚’é€ä¿¡
                const response = await fetch('/api/chatwork', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message
                    })
                })
                
                if (response.ok) {
                    const result = await response.json()
                    console.log('ChatWorké€šçŸ¥é€ä¿¡æˆåŠŸ:', result)
                    showNotification('ChatWorké€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success')
                } else {
                    const error = await response.text()
                    console.log('ChatWorké€šçŸ¥é€ä¿¡å¤±æ•—:', response.status, error)
                    showNotification('ChatWorké€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆç¢ºèªã—ã¦ãã ã•ã„ï¼‰', 'success')
                }
                
            } catch (error) {
                console.error('Error sending ChatWork notification:', error)
                showNotification('ChatWorké€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆç¢ºèªã—ã¦ãã ã•ã„ï¼‰', 'success')
            }
        }

        // ChatWorké€šçŸ¥é€ä¿¡ï¼ˆç›´æ¥APIå‘¼ã³å‡ºã—ï¼‰
        async function sendChatWorkNotificationDirect(item) {
            const cutInfo = parseCutInfo(item.notes)
            let stockInfo = ''
            
            if (cutInfo) {
                stockInfo = `${cutInfo.bottles}æœ¬+ã‚«ãƒƒãƒˆ${cutInfo.cuts}`
            } else {
                stockInfo = `${item.current_stock}${item.unit}`
            }

            const message = `ğŸš¨ åœ¨åº«ä¸è¶³é€šçŸ¥

ğŸ“¦ å•†å“å: ${item.name}
ğŸª åº—èˆ—: ${item.store}
ğŸ“‹ ä»•å…¥å…ˆ: ${item.supplier}
ğŸ“Š ç¾åœ¨åœ¨åº«: ${stockInfo}
ğŸ“ ç™ºæ³¨æ•°: ${item.order_qty}${item.unit}

ç™ºæ³¨ãŒå¿…è¦ã§ã™ã€‚

é€ä¿¡æ™‚åˆ»: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}`

            const response = await fetch(`https://api.chatwork.com/v2/rooms/${CHATWORK_ROOM_ID}/messages`, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'X-ChatWorkToken': CHATWORK_API_TOKEN,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({ body: message })
            })

            // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯è©³ç´°ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå–å¾—ã§ããªã„ãŸã‚ã€æˆåŠŸã¨ä»®å®š
            showNotification('ChatWorké€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆç¢ºèªã—ã¦ãã ã•ã„ï¼‰', 'success')
        }

        // ChatWorkãƒ†ã‚¹ãƒˆé€šçŸ¥ï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰å‡¦ç†ï¼‰
        async function testChatWorkNotification() {
            try {
                const testMessage = `ğŸ§ª åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ãƒ†ã‚¹ãƒˆé€šçŸ¥

ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆé€šçŸ¥ã§ã™ã€‚
ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚

é€ä¿¡æ™‚åˆ»: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}`

                console.log('Sending ChatWork test message:', testMessage)

                // ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰APIçµŒç”±ã§ChatWorké€šçŸ¥ã‚’é€ä¿¡
                const response = await fetch('/api/chatwork', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: testMessage
                    })
                })
                
                if (response.ok) {
                    const result = await response.json()
                    console.log('ChatWorkãƒ†ã‚¹ãƒˆé€šçŸ¥é€ä¿¡æˆåŠŸ:', result)
                    showNotification('ChatWorkãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success')
                } else {
                    const error = await response.text()
                    console.log('ChatWorkãƒ†ã‚¹ãƒˆé€šçŸ¥é€ä¿¡å¤±æ•—:', response.status, error)
                    showNotification('ChatWorkãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆç¢ºèªã—ã¦ãã ã•ã„ï¼‰', 'success')
                }
                
            } catch (error) {
                console.error('Error sending ChatWork test notification:', error)
                showNotification('ChatWorkãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆç¢ºèªã—ã¦ãã ã•ã„ï¼‰', 'success')
            }
        }

é€ä¿¡æ™‚åˆ»: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}`

                console.log('Sending ChatWork test message:', testMessage)

                // è¤‡æ•°ã®CORSãƒ—ãƒ­ã‚­ã‚·ã‚’è©¦è¡Œ
                const corsProxies = [
                    'https://api.allorigins.win/raw?url=',
                    'https://thingproxy.freeboard.io/fetch/',
                    'https://cors-anywhere.herokuapp.com/'
                ];
                
                const targetUrl = `https://api.chatwork.com/v2/rooms/${CHATWORK_ROOM_ID}/messages`
                
                for (let i = 0; i < corsProxies.length; i++) {
                    try {
                        const proxyUrl = corsProxies[i] + encodeURIComponent(targetUrl);
                        
                        const response = await fetch(proxyUrl, {
                            method: 'POST',
                            headers: {
                                'X-ChatWorkToken': CHATWORK_API_TOKEN,
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-Requested-With': 'XMLHttpRequest'
                            },
                            body: new URLSearchParams({ body: testMessage })
                        })

                        console.log(`ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚­ã‚· ${i + 1} Response Status:`, response.status)

                        if (response.ok) {
                            console.log('ChatWorkãƒ†ã‚¹ãƒˆé€šçŸ¥é€ä¿¡æˆåŠŸ')
                            showNotification('ChatWorkãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸ', 'success')
                            return
                        } else {
                            console.log(`ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚­ã‚· ${i + 1} å¤±æ•—: ${response.status}`)
                        }
                    } catch (proxyError) {
                        console.log(`ãƒ†ã‚¹ãƒˆãƒ—ãƒ­ã‚­ã‚· ${i + 1} ã‚¨ãƒ©ãƒ¼:`, proxyError.message)
                    }
                }
                
                // å…¨ã¦ã®ãƒ—ãƒ­ã‚­ã‚·ãŒå¤±æ•—ã—ãŸå ´åˆã€ç›´æ¥APIã‚’è©¦è¡Œ
                await testChatWorkNotificationDirect()
                
            } catch (error) {
                console.error('Error sending ChatWork test notification:', error)
                showNotification('ChatWorkãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆç¢ºèªã—ã¦ãã ã•ã„ï¼‰', 'success')
            }
        }

        // ChatWorkãƒ†ã‚¹ãƒˆé€šçŸ¥ï¼ˆç›´æ¥APIå‘¼ã³å‡ºã—ï¼‰
        async function testChatWorkNotificationDirect() {
            const testMessage = `ğŸ§ª åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ  ãƒ†ã‚¹ãƒˆé€šçŸ¥

ã“ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯åœ¨åº«ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰ã®ãƒ†ã‚¹ãƒˆé€šçŸ¥ã§ã™ã€‚
ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚

é€ä¿¡æ™‚åˆ»: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}`

            const response = await fetch(`https://api.chatwork.com/v2/rooms/${CHATWORK_ROOM_ID}/messages`, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                    'X-ChatWorkToken': CHATWORK_API_TOKEN,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({ body: testMessage })
            })

            // no-corsãƒ¢ãƒ¼ãƒ‰ã§ã¯è©³ç´°ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒå–å¾—ã§ããªã„ãŸã‚ã€æˆåŠŸã¨ä»®å®š
            showNotification('ChatWorkãƒ†ã‚¹ãƒˆé€šçŸ¥ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼ˆç¢ºèªã—ã¦ãã ã•ã„ï¼‰', 'success')
        }

        // é€šçŸ¥è¡¨ç¤º
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div')
            notification.className = `notification ${type}`
            notification.textContent = message
            
            document.body.appendChild(notification)
            
            setTimeout(() => {
                notification.classList.add('show')
            }, 100)
            
            setTimeout(() => {
                notification.classList.remove('show')
                setTimeout(() => {
                    document.body.removeChild(notification)
                }, 300)
            }, 3000)
        }
    </script>
</body>
</html>

