<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Âú®Â∫´ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† - SupabaseÁâà</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
        }

        .controls {
            padding: 30px;
            background: white;
            border-bottom: 1px solid #eee;
        }

        .control-group {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(168, 237, 234, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            color: #333;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(252, 182, 159, 0.4);
        }

        .filter-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: border-color 0.3s ease;
        }

        .filter-select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .inventory-grid {
            padding: 30px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .inventory-item {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            border-left: 5px solid #4facfe;
        }

        .inventory-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .inventory-item.low-stock {
            border-left-color: #ff6b6b;
            background: linear-gradient(135deg, #fff5f5 0%, #fed7d7 100%);
        }

        .inventory-item.out-of-stock {
            border-left-color: #ff4757;
            background: linear-gradient(135deg, #ffe0e0 0%, #ffb3b3 100%);
        }

        .inventory-item.cut-item {
            border-left-color: #3742fa;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f3ff 100%);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .item-name {
            font-size: 1.3em;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .item-meta {
            font-size: 0.9em;
            color: #666;
        }

        .stock-info {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .stock-display {
            font-size: 1.5em;
            font-weight: bold;
            color: #4facfe;
            margin-bottom: 5px;
        }

        .stock-display.low {
            color: #ff6b6b;
        }

        .stock-display.out {
            color: #ff4757;
        }

        .cut-info {
            background: #e6f3ff;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border: 2px solid #3742fa;
        }

        .cut-display {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
        }

        .cut-field {
            flex: 1;
        }

        .cut-field label {
            display: block;
            font-size: 0.9em;
            color: #666;
            margin-bottom: 5px;
        }

        .cut-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .stock-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .stock-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 60px;
        }

        .stock-btn.decrease {
            background: #ff6b6b;
            color: white;
        }

        .stock-btn.increase {
            background: #51cf66;
            color: white;
        }

        .stock-btn.order {
            background: #4c6ef5;
            color: white;
        }

        .stock-btn.update {
            background: #3742fa;
            color: white;
        }

        .stock-btn:hover {
            transform: translateY(-1px);
            opacity: 0.9;
        }

        .order-notification {
            margin-top: 15px;
        }

        .notification-btn {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff8e8e 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .notification-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #666;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 1000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: #51cf66;
        }

        .notification.error {
            background: #ff6b6b;
        }

        @media (max-width: 768px) {
            .inventory-grid {
                grid-template-columns: 1fr;
                padding: 15px;
            }
            
            .controls {
                padding: 15px;
            }
            
            .control-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                flex-direction: column;
            }
            
            .stats {
                grid-template-columns: repeat(2, 1fr);
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè™ Âú®Â∫´ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</h1>
            <p>SupabaseÁâà - „É™„Ç¢„É´„Çø„Ç§„É†Âú®Â∫´ÁÆ°ÁêÜÔºà„Ç´„ÉÉ„ÉàÊï∞ÂØæÂøúÔºâ</p>
        </div>

        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalItems">-</div>
                <div class="stat-label">Á∑è„Ç¢„Ç§„ÉÜ„É†Êï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="lowStockItems">-</div>
                <div class="stat-label">Âú®Â∫´‰∏çË∂≥</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalStores">-</div>
                <div class="stat-label">Â∫óËàóÊï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalSuppliers">-</div>
                <div class="stat-label">‰ªïÂÖ•ÂÖàÊï∞</div>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <button class="btn btn-primary" onclick="loadInventory()">
                    üîÑ „Éá„Éº„ÇøÊõ¥Êñ∞
                </button>
                <button class="btn btn-secondary" onclick="testChatWorkNotification()">
                    üß™ ChatWork„ÉÜ„Çπ„Éà
                </button>
                <a href="#" target="_blank" class="btn btn-warning" id="supabaseLink">
                    ‚öôÔ∏è SupabaseÁÆ°ÁêÜÁîªÈù¢
                </a>
            </div>
            
            <div class="control-group">
                <div class="filter-group">
                    <select class="filter-select" id="storeFilter" onchange="filterInventory()">
                        <option value="">ÂÖ®Â∫óËàó</option>
                    </select>
                    <select class="filter-select" id="supplierFilter" onchange="filterInventory()">
                        <option value="">ÂÖ®‰ªïÂÖ•ÂÖà</option>
                    </select>
                    <select class="filter-select" id="categoryFilter" onchange="filterInventory()">
                        <option value="">ÂÖ®„Ç´„ÉÜ„Ç¥„É™</option>
                    </select>
                    <select class="filter-select" id="statusFilter" onchange="filterInventory()">
                        <option value="">ÂÖ®„Çπ„ÉÜ„Éº„Çø„Çπ</option>
                        <option value="low">Âú®Â∫´‰∏çË∂≥</option>
                        <option value="out">Âú®Â∫´Âàá„Çå</option>
                        <option value="normal">Ê≠£Â∏∏</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="inventory-grid" id="inventoryGrid">
            <div class="loading">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>
        </div>
    </div>

    <script>
        // Áí∞Â¢ÉÂ§âÊï∞„Åã„ÇâË®≠ÂÆö„ÇíÂèñÂæóÔºàVercelÁí∞Â¢ÉÂ§âÊï∞ÂØæÂøúÔºâ
        const SUPABASE_URL = window.location.hostname === 'localhost' 
            ? 'https://yyoixwdljeoxtieeazfo.supabase.co'
            : (typeof process !== 'undefined' && process.env.SUPABASE_URL) || 'https://yyoixwdljeoxtieeazfo.supabase.co'
        
        const SUPABASE_ANON_KEY = window.location.hostname === 'localhost'
            ? 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5b2l4d2RsamVveHRpZWVhemZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjY3NTQsImV4cCI6MjA2OTUwMjc1NH0.Lp1GLRlXI57odcpNhSl5TB2bOKSSW5Ce66_KuO_7tFs'
            : (typeof process !== 'undefined' && process.env.SUPABASE_ANON_KEY) || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inl5b2l4d2RsamVveHRpZWVhemZvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5MjY3NTQsImV4cCI6MjA2OTUwMjc1NH0.Lp1GLRlXI57odcpNhSl5TB2bOKSSW5Ce66_KuO_7tFs'

        const CHATWORK_API_TOKEN = window.location.hostname === 'localhost'
            ? '5f149c4cd0bf7044e532b70d574ba655'
            : (typeof process !== 'undefined' && process.env.CHATWORK_API_TOKEN) || '5f149c4cd0bf7044e532b70d574ba655'

        const CHATWORK_ROOM_ID = window.location.hostname === 'localhost'
            ? '405830596'
            : (typeof process !== 'undefined' && process.env.CHATWORK_ROOM_ID) || '405830596'

        let inventoryData = []
        let filteredData = []

        // ÂàùÊúüÂåñÊôÇ„Å´Supabase„É™„É≥„ÇØ„ÇíË®≠ÂÆö
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('supabaseLink').href = SUPABASE_URL
            console.log('Page loaded, initializing...')
            setTimeout(() => {
                loadInventory()
            }, 1000)
        })

        // Supabase REST APIÂëº„Å≥Âá∫„ÅóÈñ¢Êï∞Ôºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞Âº∑ÂåñÔºâ
        async function supabaseRequest(endpoint, options = {}) {
            const url = `${SUPABASE_URL}/rest/v1${endpoint}`
            
            const defaultOptions = {
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                }
            }

            const finalOptions = {
                ...defaultOptions,
                ...options,
                headers: {
                    ...defaultOptions.headers,
                    ...options.headers
                }
            }

            console.log('Supabase Request:', url, finalOptions)

            try {
                const response = await fetch(url, finalOptions)
                console.log('Supabase Response Status:', response.status)
                
                if (!response.ok) {
                    const errorText = await response.text()
                    console.error('Supabase Error Response:', errorText)
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`)
                }
                
                const data = await response.json()
                console.log('Supabase Response Data:', data)
                return data
            } catch (error) {
                console.error('Supabase Request Error:', error)
                throw error
            }
        }

        // Âú®Â∫´„Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÔºà„Ç®„É©„Éº„Éè„É≥„Éâ„É™„É≥„Ç∞Âº∑ÂåñÔºâ
        async function loadInventory() {
            console.log('Loading inventory data...')
            
            try {
                document.getElementById('inventoryGrid').innerHTML = '<div class="loading">„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø‰∏≠...</div>'
                
                const data = await supabaseRequest('/inventory_items?select=*&order=name')
                console.log('Loaded inventory data:', data)
                
                if (Array.isArray(data)) {
                    inventoryData = data
                    filteredData = [...inventoryData]
                    
                    updateStats()
                    updateFilters()
                    renderInventory()
                    
                    showNotification(`${inventoryData.length}‰ª∂„ÅÆ„Ç¢„Ç§„ÉÜ„É†„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü`, 'success')
                } else {
                    throw new Error('Invalid data format received')
                }
            } catch (error) {
                console.error('Error loading inventory:', error)
                document.getElementById('inventoryGrid').innerHTML = `
                    <div class="loading">
                        „Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü<br>
                        „Ç®„É©„Éº: ${error.message}<br>
                        <button class="btn btn-primary" onclick="loadInventory()" style="margin-top: 10px;">ÂÜçË©¶Ë°å</button>
                    </div>
                `
                showNotification('„Éá„Éº„Çø„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error')
            }
        }

        // Áµ±Ë®àÊÉÖÂ†±Êõ¥Êñ∞
        function updateStats() {
            const totalItems = inventoryData.length
            const lowStockItems = inventoryData.filter(item => item.current_stock <= item.min_stock).length
            const stores = [...new Set(inventoryData.map(item => item.store))]
            const suppliers = [...new Set(inventoryData.map(item => item.supplier))]

            document.getElementById('totalItems').textContent = totalItems
            document.getElementById('lowStockItems').textContent = lowStockItems
            document.getElementById('totalStores').textContent = stores.length
            document.getElementById('totalSuppliers').textContent = suppliers.length
        }

        // „Éï„Ç£„É´„Çø„ÉºÊõ¥Êñ∞
        function updateFilters() {
            const stores = [...new Set(inventoryData.map(item => item.store))].sort()
            const suppliers = [...new Set(inventoryData.map(item => item.supplier))].sort()
            const categories = [...new Set(inventoryData.map(item => item.category))].filter(cat => cat).sort()

            updateSelectOptions('storeFilter', stores)
            updateSelectOptions('supplierFilter', suppliers)
            updateSelectOptions('categoryFilter', categories)
        }

        function updateSelectOptions(selectId, options) {
            const select = document.getElementById(selectId)
            const currentValue = select.value
            
            while (select.children.length > 1) {
                select.removeChild(select.lastChild)
            }
            
            options.forEach(option => {
                const optionElement = document.createElement('option')
                optionElement.value = option
                optionElement.textContent = option
                select.appendChild(optionElement)
            })
            
            select.value = currentValue
        }

        // „Éï„Ç£„É´„Çø„É™„É≥„Ç∞
        function filterInventory() {
            const storeFilter = document.getElementById('storeFilter').value
            const supplierFilter = document.getElementById('supplierFilter').value
            const categoryFilter = document.getElementById('categoryFilter').value
            const statusFilter = document.getElementById('statusFilter').value

            filteredData = inventoryData.filter(item => {
                const storeMatch = !storeFilter || item.store === storeFilter
                const supplierMatch = !supplierFilter || item.supplier === supplierFilter
                const categoryMatch = !categoryFilter || item.category === categoryFilter
                
                let statusMatch = true
                if (statusFilter === 'low') {
                    statusMatch = item.current_stock <= item.min_stock && item.current_stock > 0
                } else if (statusFilter === 'out') {
                    statusMatch = item.current_stock <= 0
                } else if (statusFilter === 'normal') {
                    statusMatch = item.current_stock > item.min_stock
                }

                return storeMatch && supplierMatch && categoryMatch && statusMatch
            })

            renderInventory()
        }

        // „Ç´„ÉÉ„ÉàÊï∞ÊÉÖÂ†±„ÅÆËß£Êûê
        function parseCutInfo(notes) {
            if (!notes) return null
            
            const cutMatch = notes.match(/(\d+(?:\.\d+)?)Êú¨\+„Ç´„ÉÉ„Éà(\d+(?:\.\d+)?)/)
            if (cutMatch) {
                return {
                    bottles: parseFloat(cutMatch[1]),
                    cuts: parseFloat(cutMatch[2])
                }
            }
            return null
        }

        // „Ç´„ÉÉ„ÉàÊï∞ÊÉÖÂ†±„ÅÆÁîüÊàê
        function generateCutNotes(bottles, cuts) {
            return `${bottles}Êú¨+„Ç´„ÉÉ„Éà${cuts}`
        }

        // Âú®Â∫´Ë°®Á§∫
        function renderInventory() {
            const grid = document.getElementById('inventoryGrid')
            
            if (filteredData.length === 0) {
                grid.innerHTML = '<div class="loading">Ë©≤ÂΩì„Åô„Çã„Ç¢„Ç§„ÉÜ„É†„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>'
                return
            }

            grid.innerHTML = filteredData.map(item => {
                const isLowStock = item.current_stock <= item.min_stock && item.current_stock > 0
                const isOutOfStock = item.current_stock <= 0
                const cutInfo = parseCutInfo(item.notes)
                
                let statusClass = ''
                if (cutInfo) {
                    statusClass = 'cut-item'
                } else if (isOutOfStock) {
                    statusClass = 'out-of-stock'
                } else if (isLowStock) {
                    statusClass = 'low-stock'
                }

                let stockDisplay = ''
                if (cutInfo) {
                    stockDisplay = `
                        <div class="cut-info">
                            <div class="cut-display">
                                <div class="cut-field">
                                    <label>Êú¨Êï∞</label>
                                    <input type="number" class="cut-input" id="bottles-${item.id}" value="${cutInfo.bottles}" step="0.5" min="0">
                                </div>
                                <div class="cut-field">
                                    <label>„Ç´„ÉÉ„ÉàÊï∞</label>
                                    <input type="number" class="cut-input" id="cuts-${item.id}" value="${cutInfo.cuts}" step="1" min="0">
                                </div>
                            </div>
                            <div class="stock-controls">
                                <button class="stock-btn decrease" onclick="adjustCutStock(${item.id}, 'bottles', -1)">Êú¨-1</button>
                                <button class="stock-btn increase" onclick="adjustCutStock(${item.id}, 'bottles', 1)">Êú¨+1</button>
                                <button class="stock-btn decrease" onclick="adjustCutStock(${item.id}, 'cuts', -1)">„Ç´„ÉÉ„Éà-1</button>
                                <button class="stock-btn increase" onclick="adjustCutStock(${item.id}, 'cuts', 1)">„Ç´„ÉÉ„Éà+1</button>
                                <button class="stock-btn order" onclick="adjustCutStock(${item.id}, 'bottles', ${item.order_qty})">+${item.order_qty}Êú¨</button>
                                <button class="stock-btn update" onclick="updateCutStock(${item.id})">Êõ¥Êñ∞</button>
                            </div>
                        </div>
                    `
                } else {
                    const stockClass = isOutOfStock ? 'out' : (isLowStock ? 'low' : '')
                    stockDisplay = `
                        <div class="stock-info">
                            <div class="stock-display ${stockClass}">
                                ÁèæÂú®: ${item.current_stock}${item.unit} / ÊúÄ‰Ωé: ${item.min_stock}${item.unit}
                            </div>
                            <div class="stock-controls">
                                <button class="stock-btn decrease" onclick="updateStock(${item.id}, ${item.current_stock - 0.5})">-0.5</button>
                                <button class="stock-btn decrease" onclick="updateStock(${item.id}, ${item.current_stock - 1})">-1</button>
                                <button class="stock-btn increase" onclick="updateStock(${item.id}, ${item.current_stock + 1})">+1</button>
                                <button class="stock-btn order" onclick="updateStock(${item.id}, ${item.current_stock + item.order_qty})">+${item.order_qty}</button>
                            </div>
                        </div>
                    `
                }

                const needsOrder = item.current_stock <= item.min_stock
                const orderButton = needsOrder ? `
                    <div class="order-notification">
                        <button class="notification-btn" onclick="sendOrderNotification(${item.id})">
                            üì± Áô∫Ê≥®ÈÄöÁü•
                        </button>
                    </div>
                ` : ''

                return `
                    <div class="inventory-item ${statusClass}">
                        <div class="item-header">
                            <div>
                                <div class="item-name">${item.name}</div>
                                <div class="item-meta">
                                    üè™ ${item.store} | üì¶ ${item.supplier} | üìÇ ${item.category || 'Êú™ÂàÜÈ°û'}
                                </div>
                            </div>
                        </div>
                        ${stockDisplay}
                        ${orderButton}
                    </div>
                `
            }).join('')
        }

        // „Ç´„ÉÉ„ÉàÊï∞Ë™øÊï¥
        function adjustCutStock(itemId, type, amount) {
            const input = document.getElementById(`${type}-${itemId}`)
            const currentValue = parseFloat(input.value) || 0
            const newValue = Math.max(0, currentValue + amount)
            input.value = newValue
        }

        // „Ç´„ÉÉ„ÉàÊï∞Êõ¥Êñ∞
        async function updateCutStock(itemId) {
            const bottlesInput = document.getElementById(`bottles-${itemId}`)
            const cutsInput = document.getElementById(`cuts-${itemId}`)
            
            const bottles = parseFloat(bottlesInput.value) || 0
            const cuts = parseFloat(cutsInput.value) || 0
            
            if (bottles < 0 || cuts < 0) {
                showNotification('Êú¨Êï∞„Éª„Ç´„ÉÉ„ÉàÊï∞„ÅØ0‰ª•‰∏ä„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô', 'error')
                return
            }

            try {
                const notes = generateCutNotes(bottles, cuts)
                
                await supabaseRequest(`/inventory_items?id=eq.${itemId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ 
                        current_stock: bottles,
                        notes: notes
                    })
                })

                const itemIndex = inventoryData.findIndex(item => item.id === itemId)
                if (itemIndex !== -1) {
                    inventoryData[itemIndex].current_stock = bottles
                    inventoryData[itemIndex].notes = notes
                }
                
                filterInventory()
                updateStats()
                showNotification('„Ç´„ÉÉ„ÉàÊï∞„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success')
            } catch (error) {
                console.error('Error updating cut stock:', error)
                showNotification('„Ç´„ÉÉ„ÉàÊï∞Êõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error')
            }
        }

        // Âú®Â∫´Êõ¥Êñ∞
        async function updateStock(itemId, newStock) {
            if (newStock < 0) {
                showNotification('Âú®Â∫´Êï∞„ÅØ0‰ª•‰∏ä„Åß„ÅÇ„ÇãÂøÖË¶Å„Åå„ÅÇ„Çä„Åæ„Åô', 'error')
                return
            }

            try {
                await supabaseRequest(`/inventory_items?id=eq.${itemId}`, {
                    method: 'PATCH',
                    body: JSON.stringify({ current_stock: newStock })
                })

                const itemIndex = inventoryData.findIndex(item => item.id === itemId)
                if (itemIndex !== -1) {
                    inventoryData[itemIndex].current_stock = newStock
                }
                
                filterInventory()
                updateStats()
                showNotification('Âú®Â∫´„ÇíÊõ¥Êñ∞„Åó„Åæ„Åó„Åü', 'success')
            } catch (error) {
                console.error('Error updating stock:', error)
                showNotification('Âú®Â∫´Êõ¥Êñ∞‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error')
            }
        }

        // Áô∫Ê≥®ÈÄöÁü•ÈÄÅ‰ø°
        async function sendOrderNotification(itemId) {
            try {
                const item = inventoryData.find(item => item.id === itemId)
                if (item) {
                    await sendChatWorkNotification(item)
                }
            } catch (error) {
                console.error('Error sending order notification:', error)
                showNotification('Áô∫Ê≥®ÈÄöÁü•„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error')
            }
        }

        // ChatWorkÈÄöÁü•ÈÄÅ‰ø°
        async function sendChatWorkNotification(item) {
            try {
                const cutInfo = parseCutInfo(item.notes)
                let stockInfo = ''
                
                if (cutInfo) {
                    stockInfo = `${cutInfo.bottles}Êú¨+„Ç´„ÉÉ„Éà${cutInfo.cuts}`
                } else {
                    stockInfo = `${item.current_stock}${item.unit}`
                }

                const message = `üö® Âú®Â∫´‰∏çË∂≥ÈÄöÁü•

üì¶ ÂïÜÂìÅÂêç: ${item.name}
üè™ Â∫óËàó: ${item.store}
üìã ‰ªïÂÖ•ÂÖà: ${item.supplier}
üìä ÁèæÂú®Âú®Â∫´: ${stockInfo}
‚ö†Ô∏è ÊúÄ‰ΩéÂú®Â∫´: ${item.min_stock}${item.unit}
üìù Áô∫Ê≥®Êï∞: ${item.order_qty}${item.unit}

Áô∫Ê≥®„ÅåÂøÖË¶Å„Åß„Åô„ÄÇ

ÈÄÅ‰ø°ÊôÇÂàª: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}`

                const response = await fetch(`https://api.chatwork.com/v2/rooms/${CHATWORK_ROOM_ID}/messages`, {
                    method: 'POST',
                    headers: {
                        'X-ChatWorkToken': CHATWORK_API_TOKEN,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({ body: message })
                })

                if (response.ok) {
                    showNotification('ChatWorkÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü', 'success')
                } else {
                    const errorText = await response.text()
                    console.error('ChatWork API Error:', errorText)
                    showNotification('ChatWorkÈÄöÁü•„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error')
                }
            } catch (error) {
                console.error('Error sending ChatWork notification:', error)
                showNotification('ChatWorkÈÄöÁü•„ÅÆÈÄÅ‰ø°‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error')
            }
        }

        // ChatWork„ÉÜ„Çπ„ÉàÈÄöÁü•
        async function testChatWorkNotification() {
            try {
                const testMessage = `üß™ Âú®Â∫´ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É† „ÉÜ„Çπ„ÉàÈÄöÁü•

„Åì„ÅÆ„É°„ÉÉ„Çª„Éº„Ç∏„ÅØÂú®Â∫´ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†„Åã„Çâ„ÅÆ„ÉÜ„Çπ„ÉàÈÄöÁü•„Åß„Åô„ÄÇ
„Ç∑„Çπ„ÉÜ„É†„ÅåÊ≠£Â∏∏„Å´Âãï‰Ωú„Åó„Å¶„ÅÑ„Çã„Åì„Å®„ÇíÁ¢∫Ë™ç„Åó„Åæ„Åó„Åü„ÄÇ

ÈÄÅ‰ø°ÊôÇÂàª: ${new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' })}`

                const response = await fetch(`https://api.chatwork.com/v2/rooms/${CHATWORK_ROOM_ID}/messages`, {
                    method: 'POST',
                    headers: {
                        'X-ChatWorkToken': CHATWORK_API_TOKEN,
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({ body: testMessage })
                })

                if (response.ok) {
                    showNotification('ChatWork„ÉÜ„Çπ„ÉàÈÄöÁü•„ÇíÈÄÅ‰ø°„Åó„Åæ„Åó„Åü', 'success')
                } else {
                    const errorText = await response.text()
                    console.error('ChatWork API Error:', errorText)
                    showNotification('ChatWork„ÉÜ„Çπ„ÉàÈÄöÁü•„ÅÆÈÄÅ‰ø°„Å´Â§±Êïó„Åó„Åæ„Åó„Åü', 'error')
                }
            } catch (error) {
                console.error('Error sending test notification:', error)
                showNotification('ChatWork„ÉÜ„Çπ„ÉàÈÄöÁü•„ÅÆÈÄÅ‰ø°‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü', 'error')
            }
        }

        // ÈÄöÁü•Ë°®Á§∫
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div')
            notification.className = `notification ${type}`
            notification.textContent = message
            document.body.appendChild(notification)

            setTimeout(() => notification.classList.add('show'), 100)
            setTimeout(() => {
                notification.classList.remove('show')
                setTimeout(() => document.body.removeChild(notification), 300)
            }, 3000)
        }
    </script>
</body>
</html>

